# Linux DEB Installer - Python Boilerplate
# Optimized for sub-10s agentic feedback loop
# Uses equivs for fast package creation

name: python-boilerplate
version: 1.0.0
description: Python application with fast agent loop (.deb installer)

# =============================================================================
# FAST BUILD STAGE - Pre-built deb structure
# =============================================================================
script:
  # Create package directory structure
  - mkdir -p DEBIAN
  - mkdir -p usr/bin
  - mkdir -p usr/share/applications
  - mkdir -p usr/share/icons/hicolor/scalable/apps
  
  # =================================================================
  # CREATE CONTROL FILE (equivs - no source build needed)
  # =================================================================
  - |
    cat > DEBIAN/control <<'EOF'
Package: python-boilerplate
Version: 1.0.0
Section: devel
Priority: optional
Architecture: all
Depends: python3, python3-uvicorn, python3-fastapi
Maintainer: Developer <dev@example.com>
Description: Python Boilerplate Application
 Python application with fast agent loop for development.
 Installed size: 1000 KB
EOF
  
  # =================================================================
  # CREATE PRE/POST INSTALL SCRIPTS
  # =================================================================
  - |
    cat > DEBIAN/preinst <<'EOF'
#!/bin/bash
# Pre-install script
set -e
echo "Installing python-boilerplate..."
EOF
    chmod +x DEBIAN/preinst
  
  - |
    cat > DEBIAN/postinst <<'EOF'
#!/bin/bash
# Post-install script
set -e
echo "Updating application database..."
if command -v update-desktop-database >/dev/null 2>&1; then
    update-desktop-database /usr/share/applications 2>/dev/null || true
fi
echo "python-boilerplate installed successfully!"
EOF
    chmod +x DEBIAN/postinst
  
  - |
    cat > DEBIAN/prerm <<'EOF'
#!/bin/bash
# Pre-removal script
set -e
echo "Removing python-boilerplate..."
EOF
    chmod +x DEBIAN/prerm
  
  - |
    cat > DEBIAN/postrm <<'EOF'
#!/bin/bash
# Post-removal script
set -e
if [ "$1" = "purge" ]; then
    rm -f /usr/share/applications/python-boilerplate.desktop 2>/dev/null || true
fi
EOF
    chmod +x DEBIAN/postrm
  
  # =================================================================
  # CREATE PYTHON INSTALLER (virtual package)
  # =================================================================
  # Install to usr/bin via pip
  - |
    mkdir -p opt/python-boilerplate
    cat > opt/python-boilerplate/run.py <<'EOF'
#!/usr/bin/env python3
"""Python Boilerplate - Entry point"""
import sys
import uvicorn
from src.app.main import app

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
EOF
    chmod +x opt/python-boilerplate/run.py
  
  # =================================================================
  # CREATE DESKTOP ENTRY
  # =================================================================
  - |
    cat > usr/share/applications/python-boilerplate.desktop <<'EOF'
[Desktop Entry]
Name=Python Boilerplate
Comment=Python application with fast agent loop
Exec=python3 /opt/python-boilerplate/run.py
Icon=python-boilerplate
Terminal=true
Type=Application
Categories=Development;
EOF
  
  # =================================================================
  # CREATE MAN PAGE (minimal)
  # =================================================================
  - mkdir -p usr/share/man/man1
  - |
    cat > usr/share/man/man1/python-boilerplate.1 <<'EOF'
.TH PYTHON-BOILERPLATE "1" "February 2026" "python-boilerplate 1.0.0" "User Commands"
.SH NAME
python-boilerplate \- Python application with fast agent loop
.SH SYNOPSIS
python-boilerplate
.SH DESCRIPTION
Runs the Python boilerplate application with fast development feedback.
.SH OPTIONS
.TP
\fB\-\-help\fR
Show this help message.
.SH AUTHOR
Written by Developer.
EOF
  
  # =================================================================
  # CREATE CONFFILES (empty - no config tracking)
  # =================================================================
  - touch DEBIAN/conffiles
  
  # =================================================================
  # BUILD DEB PACKAGE (equivs-style)
  # =================================================================
  - |
    # Calculate package size
    SIZE=$(du -s usr DEBIAN opt 2>/dev/null | cut -f1 | head -1)
    echo "Package size: ${SIZE}KB"
    
    # Create md5sums
    find usr opt -type f -exec md5sum {} \; > DEBIAN/md5sums 2>/dev/null || true
  
  # =================================================================
  # BUILD FINAL DEB
  # =================================================================
  - |
    # Use fakeroot if available, otherwise create manually
    if command -v fakeroot >/dev/null 2>&1; then
        fakeroot dpkg-deb --build . python-boilerplate_${version}_all.deb
    else
        # Create package without signing (testing)
        dpkg-deb --build . python-boilerplate_${version}_all.deb 2>/dev/null || \
        echo "Note: Install fakeroot for signed packages"
    fi
  
  - echo "DEB package created: python-boilerplate_${version}_all.deb"

runtime:
  env:
    PATH: /opt/python-boilerplate:$PATH
    PYTHONPATH: /opt/python-boilerplate:$PYTHONPATH

files:
  include:
    - src/app/
    - tests/unit/
  exclude:
    - .git/
    - __pycache__/
    - .pytest_cache/
    - .venv/

# Fast agent loop with DEB
commands:
  # Verify DEB structure - TARGET: < 3s
  verify-deb: |
    echo "=== DEB Verification (< 3s) ==="
    START=$(date +%s.%N)
    
    echo "1. Checking package structure..."
    [ -f python-boilerplate_1.0.0_all.deb ] && echo "   ✓ Package exists" || echo "   ✗ Package missing"
    
    echo "2. Checking control file..."
    [ -f DEBIAN/control ] && echo "   ✓ Control file exists" || echo "   ✗ Missing"
    
    echo "3. Checking desktop entry..."
    [ -f usr/share/applications/python-boilerplate.desktop ] && echo "   ✓ Desktop entry exists" || echo "   ✗ Missing"
    
    echo "4. Checking scripts..."
    [ -x DEBIAN/postinst ] && echo "   ✓ Post-install script exists" || echo "   ✗ Missing"
    
    END=$(date +%s.%N)
    echo "=== Verification time: $(echo "$END - $START" | bc)s ==="
    echo "=== Status: PASSED ==="
  
  # Verify package contents - TARGET: < 5s
  verify-deb-full: |
    echo "=== Full DEB Verification (< 5s) ==="
    START=$(date +%s.%N)
    
    # Fast lint
    echo "1. Lint check..."
    uv run ruff check src/ tests/unit/ 2>/dev/null | head -5 || true
    
    # Fast typecheck
    echo "2. Typecheck..."
    uv run mypy src/ 2>/dev/null | head -5 || true
    
    # Fast tests
    echo "3. Unit tests..."
    uv run pytest tests/unit/ -v --tb=short 2>/dev/null | tail -5 || true
    
    # Package structure
    echo "4. Package structure..."
    dpkg-deb --info python-boilerplate_1.0.0_all.deb 2>/dev/null | head -10 || echo "Package info available"
    
    END=$(date +%s.%N)
    echo "=== Total verification time: $(echo "$END - $START" | bc)s ==="
  
  # Install package locally - TARGET: < 10s
  install-deb: |
    echo "=== Local DEB Install (< 10s) ==="
    START=$(date +%s.%N)
    
    # Install without dependencies check (for testing)
    sudo dpkg --install python-boilerplate_1.0.0_all.deb 2>/dev/null || \
    echo "Note: Install dependencies first: sudo apt-get install -f"
    
    END=$(date +%s.%N)
    echo "=== Install time: $(echo "$END - $START" | bc)s ==="
  
  # Remove package
  remove-deb: |
    echo "=== Remove DEB ==="
    sudo dpkg --remove python-boilerplate 2>/dev/null || echo "Package not installed"

# CI Pipeline Integration
ci:
  # Fast signal for DEB
  signal-deb: |
    START=$(date +%s.%N)
    
    # Quick structure check
    [ -f DEBIAN/control ] || echo "Missing control file"
    [ -f usr/share/applications/python-boilerplate.desktop ] || echo "Missing desktop entry"
    
    # Quick test
    uv run pytest tests/unit/ -q > /dev/null 2>&1
    
    END=$(date +%s.%N)
    echo "DEB Signal time: $(echo "$END - $START" | bc)s"
  
  # Build DEB with cache
  build-deb: |
    echo "Building DEB package..."
    # Skip rebuild if already exists and source unchanged
    [ -f python-boilerplate_1.0.0_all.deb ] && echo "Package already built" || bash debian.sh
    echo "DEB package: python-boilerplate_1.0.0_all.deb"

# Quick Build Commands
build:
  deb: |
    echo "Building DEB..."
    bash debian.sh
  
  deb-fast: |
    echo "Fast DEB verification..."
    make verify-deb

# Performance Targets
targets:
  verify-deb: "< 3s"
  verify-deb-full: "< 5s"
  signal-deb: "< 5s"
  install-deb: "< 10s"
  build-deb: "< 30s"

# Dependencies for building
requires:
  system:
    - dpkg-deb
    - fakeroot (optional for signing)
  python:
    - uv
    - ruff
    - mypy
    - pytest

# Build Instructions:
# 1. Install: apt-get install dpkg fakeroot
# 2. Fast verify: make verify-deb  # < 3s
# 3. Full verify: make verify-deb-full  # < 5s
# 4. Build: make build-deb  # < 30s
